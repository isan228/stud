<%- include('partials/header', { title: 'Избранные вопросы' }) %>

<div class="row">
    <div class="col-12">
        <div class="card shadow mb-4">
            <div class="card-header bg-warning text-dark">
                <h3 class="mb-0"><i class="bi bi-star-fill"></i> Избранные вопросы</h3>
            </div>
            <div class="card-body">
                <% if (favorites && favorites.length > 0) { %>
                    <div class="alert alert-success mb-3">
                        <h5><i class="bi bi-star-fill"></i> Всего избранных вопросов: <strong><%= favorites.length %></strong></h5>
                        <a href="/tests/favorites/test" class="btn btn-warning btn-lg">
                            <i class="bi bi-play-circle"></i> Пройти тест из избранных вопросов
                        </a>
                    </div>
                    
                    <% if (favoritesByTest && Object.keys(favoritesByTest).length > 0) { %>
                        <div class="mb-4">
                            <h5>Группировка по тестам:</h5>
                            <% Object.values(favoritesByTest).forEach(group => { %>
                                <div class="card mb-2">
                                    <div class="card-body">
                                        <h6><%= group.test.title %></h6>
                                        <p class="mb-0">
                                            Предмет: <strong><%= group.test.subject %></strong> | 
                                            Вопросов: <strong><%= group.questions.length %></strong>
                                        </p>
                                        <a href="/tests/emulator/<%= group.test.id %>" class="btn btn-sm btn-primary mt-2">
                                            <i class="bi bi-play"></i> Пройти тест
                                        </a>
                                    </div>
                                </div>
                            <% }); %>
                        </div>
                    <% } %>
                    
                    <hr>
                    <h5>Все избранные вопросы:</h5>
                    
                    <% favorites.forEach((favorite, index) => { 
                        const question = favorite.Question;
                        const test = question ? question.Test : null;
                    %>
                        <div class="card mb-3">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <div>
                                    <h5 class="mb-0">Вопрос #<%= index + 1 %></h5>
                                    <% if (test) { %>
                                        <small class="text-muted">
                                            Тест: <strong><%= test.title %></strong> | 
                                            Предмет: <strong><%= test.subject %></strong>
                                        </small>
                                    <% } %>
                                </div>
                                <div>
                                    <button class="btn btn-sm btn-outline-danger" onclick="removeFavorite(<%= question.id %>)">
                                        <i class="bi bi-star"></i> Удалить из избранного
                                    </button>
                                    <% if (test) { %>
                                        <a href="/tests/emulator/<%= test.id %>" class="btn btn-sm btn-primary">
                                            <i class="bi bi-play"></i> Пройти тест
                                        </a>
                                    <% } %>
                                </div>
                            </div>
                            <div class="card-body">
                                <p class="fw-bold"><%= question.text %></p>
                                
                                <% if (question.Answers && question.Answers.length > 0) { %>
                                    <div class="answers mt-3">
                                        <h6>Варианты ответов:</h6>
                                        <ul class="list-group">
                                            <% question.Answers.forEach(answer => { %>
                                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                                    <%= answer.text %>
                                                    <% if (answer.isCorrect) { %>
                                                        <span class="badge bg-success">Правильный ответ</span>
                                                    <% } %>
                                                </li>
                                            <% }); %>
                                        </ul>
                                    </div>
                                <% } %>
                                
                                <div class="mt-3">
                                    <small class="text-muted">
                                        Добавлено в избранное: <%= new Date(favorite.createdAt).toLocaleString('ru-RU') %>
                                    </small>
                                </div>
                            </div>
                        </div>
                    <% }); %>
                <% } else { %>
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> У вас пока нет избранных вопросов.
                        <br>Добавляйте вопросы в избранное во время прохождения тестов!
                    </div>
                <% } %>
            </div>
        </div>
        
        <div class="mb-3">
            <a href="/tests/emulator" class="btn btn-outline-primary">
                <i class="bi bi-arrow-left"></i> Вернуться к тестам
            </a>
        </div>
    </div>
</div>

<script>
async function removeFavorite(questionId) {
    if (!confirm('Удалить этот вопрос из избранного?')) {
        return;
    }
    
    try {
        const response = await fetch('/api/favorite/remove', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ questionId })
        });
        
        const data = await response.json();
        
        if (data.success) {
            location.reload();
        } else {
            alert('Ошибка при удалении из избранного');
        }
    } catch (error) {
        console.error('Ошибка:', error);
        alert('Ошибка при удалении из избранного');
    }
}
</script>

<%- include('partials/footer') %>

