<%- include('partials/header', { title: 'Подписка' }) %>

<% if (typeof error !== 'undefined' && error) { %>
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <%= error %>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
<% } %>

<div class="row">
    <div class="col-12">
        <div class="text-center mb-5">
            <h1 class="display-4 fw-bold mb-3">Выберите подписку</h1>
            <p class="lead text-muted">Оформите подписку и получите полный доступ ко всем возможностям платформы</p>
        </div>
    </div>
</div>

<div class="row mb-5">
    <div class="col-md-6 mb-4">
        <div class="card border-primary h-100 shadow-lg subscription-card animate-slide-up" data-delay="0">
            <div class="card-header bg-primary text-white text-center py-4">
                <h3 class="mb-0"><i class="bi bi-person-fill"></i> Индивидуальная</h3>
            </div>
            <div class="card-body p-4">
                <div class="text-center mb-4">
                    <h2 class="text-primary mb-2">Выберите срок</h2>
                </div>
                <div class="d-grid gap-2 mb-4">
                    <button class="btn btn-outline-primary btn-lg subscription-option" data-type="individual" data-duration="1">
                        <i class="bi bi-calendar-month"></i> 1 месяц
                        <span class="badge bg-primary ms-2">Популярно</span>
                    </button>
                    <button class="btn btn-outline-primary btn-lg subscription-option" data-type="individual" data-duration="3">
                        <i class="bi bi-calendar3"></i> 3 месяца
                        <span class="badge bg-success ms-2">Выгодно</span>
                    </button>
                    <button class="btn btn-outline-primary btn-lg subscription-option" data-type="individual" data-duration="6">
                        <i class="bi bi-calendar-check"></i> 6 месяцев
                        <span class="badge bg-warning ms-2">Лучшая цена</span>
                    </button>
                </div>
                <ul class="list-unstyled">
                    <li class="mb-2"><i class="bi bi-check-circle-fill text-success"></i> Полный доступ ко всем тестам</li>
                    <li class="mb-2"><i class="bi bi-check-circle-fill text-success"></i> Неограниченное количество попыток</li>
                    <li class="mb-2"><i class="bi bi-check-circle-fill text-success"></i> Детальная статистика</li>
                    <li class="mb-2"><i class="bi bi-check-circle-fill text-success"></i> Работа над ошибками</li>
                    <li class="mb-2"><i class="bi bi-check-circle-fill text-success"></i> Избранное</li>
                </ul>
            </div>
        </div>
    </div>
    <div class="col-md-6 mb-4">
        <div class="card border-success h-100 shadow-lg subscription-card animate-slide-up" data-delay="100">
            <div class="card-header bg-success text-white text-center py-4">
                <h3 class="mb-0"><i class="bi bi-people-fill"></i> Групповая</h3>
            </div>
            <div class="card-body p-4">
                <div class="text-center mb-4">
                    <h2 class="text-success mb-2">Скидка для группы</h2>
                    <p class="text-muted">От 10 человек</p>
                </div>
                <div class="d-grid gap-2 mb-4">
                    <button class="btn btn-outline-success btn-lg subscription-option" data-type="group" data-duration="3">
                        <i class="bi bi-calendar3"></i> 3 месяца
                        <span class="badge bg-success ms-2">Групповая скидка</span>
                    </button>
                    <button class="btn btn-outline-success btn-lg subscription-option" data-type="group" data-duration="6">
                        <i class="bi bi-calendar-check"></i> 6 месяцев
                        <span class="badge bg-success ms-2">Максимальная выгода</span>
                    </button>
                </div>
                <ul class="list-unstyled">
                    <li class="mb-2"><i class="bi bi-check-circle-fill text-success"></i> Все возможности индивидуальной подписки</li>
                    <li class="mb-2"><i class="bi bi-check-circle-fill text-success"></i> Выгодная групповая скидка</li>
                    <li class="mb-2"><i class="bi bi-check-circle-fill text-success"></i> Отдельный аккаунт для каждого</li>
                    <li class="mb-2"><i class="bi bi-check-circle-fill text-success"></i> Идеально для учебных групп</li>
                    <li class="mb-2"><i class="bi bi-check-circle-fill text-success"></i> Гибкая оплата</li>
                </ul>
                <div class="alert alert-info mt-3">
                    <i class="bi bi-info-circle"></i> Объединитесь с друзьями — соберите группу из 10 человек и получите выгодную групповую скидку.
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для регистрации/входа -->
<div class="modal fade" id="subscriptionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Оформление подписки</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="subscriptionInfo" class="alert alert-info mb-3">
                    <h6>Выбранная подписка:</h6>
                    <p class="mb-0" id="selectedSubscription"></p>
                </div>
                
                <% if (typeof user === 'undefined' || !user) { %>
                    <div class="alert alert-info mb-4">
                        <h5><i class="bi bi-info-circle"></i> Регистрация</h5>
                        <p class="mb-0">Для оформления подписки необходимо заполнить данные регистрации на странице оплаты. Аккаунт будет создан после успешной оплаты.</p>
                    </div>
                    
                    <!-- Кнопка перехода к оплате для неавторизованных пользователей -->
                    <form id="guestPurchaseForm" method="GET" action="/payment" class="mb-4">
                        <input type="hidden" name="type" id="guestSubscriptionType">
                        <input type="hidden" name="duration" id="guestSubscriptionDuration">
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg" id="guestGoToPaymentBtn" style="display: none;">
                                <i class="bi bi-credit-card"></i> Перейти к оплате
                            </button>
                        </div>
                    </form>
                    
                    <div class="mb-4">
                        <h5>У вас уже есть аккаунт?</h5>
                        <a href="/auth/login" class="btn btn-outline-primary w-100">
                            <i class="bi bi-box-arrow-in-right"></i> Войти в аккаунт
                        </a>
                    </div>
                <% } else { %>
                    <div class="text-center mb-4">
                        <p class="lead">Вы уже авторизованы как <strong><%= user.nickname %></strong></p>
                        <p class="mb-3">Выберите подписку выше и нажмите на кнопку выбора, чтобы перейти к оплате.</p>
                    </div>
                    <form id="purchaseForm" method="GET" action="/payment">
                        <input type="hidden" name="subscriptionType" id="purchaseSubscriptionType">
                        <input type="hidden" name="subscriptionDuration" id="purchaseSubscriptionDuration">
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg" id="goToPaymentBtn" style="display: none;">
                                <i class="bi bi-credit-card"></i> Перейти к оплате
                            </button>
                            <a href="/profile" class="btn btn-outline-secondary">
                                <i class="bi bi-person-circle"></i> Перейти в личный кабинет
                            </a>
                        </div>
                    </form>
                <% } %>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-body">
                <h4 class="mb-3"><i class="bi bi-info-circle-fill text-primary"></i> Дополнительная информация</h4>
                <p>Какие возможности предоставляет платная подписка: <a href="/help#features">ссылка на "⭐ ВОЗМОЖНОСТИ ПОДПИСКИ"</a></p>
                <p class="text-muted mb-0"><i class="bi bi-shield-check"></i> Стоимость подписки зафиксирована с 2025 года.</p>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const subscriptionOptions = document.querySelectorAll('.subscription-option');
    const modal = new bootstrap.Modal(document.getElementById('subscriptionModal'));
    const selectedSubscriptionEl = document.getElementById('selectedSubscription');
    const subscriptionTypeInput = document.getElementById('subscriptionType');
    const subscriptionDurationInput = document.getElementById('subscriptionDuration');
    const purchaseForm = document.getElementById('purchaseForm');

    subscriptionOptions.forEach(option => {
        option.addEventListener('click', function() {
            const type = this.getAttribute('data-type');
            const duration = this.getAttribute('data-duration');
            
            // Убираем активный класс со всех кнопок
            subscriptionOptions.forEach(opt => opt.classList.remove('active'));
            // Добавляем активный класс к выбранной
            this.classList.add('active');
            
            // Формируем текст выбранной подписки
            const typeText = type === 'individual' ? 'Индивидуальная' : 'Групповая';
            const durationText = duration === '1' ? '1 месяц' : duration === '3' ? '3 месяца' : '6 месяцев';
            
            selectedSubscriptionEl.textContent = `${typeText} подписка на ${durationText}`;
            
            if (subscriptionTypeInput) subscriptionTypeInput.value = type;
            if (subscriptionDurationInput) subscriptionDurationInput.value = duration;
            
            // Обновляем скрытые поля в форме покупки, если она есть
            if (purchaseForm) {
                const purchaseTypeInput = purchaseForm.querySelector('input[name="subscriptionType"]');
                const purchaseDurationInput = purchaseForm.querySelector('input[name="subscriptionDuration"]');
                if (purchaseTypeInput) purchaseTypeInput.value = type;
                if (purchaseDurationInput) purchaseDurationInput.value = duration;
            }
            
            // Если пользователь авторизован, показываем кнопку "Перейти к оплате" вместо модального окна
            const goToPaymentBtn = document.getElementById('goToPaymentBtn');
            const purchaseSubscriptionType = document.getElementById('purchaseSubscriptionType');
            const purchaseSubscriptionDuration = document.getElementById('purchaseSubscriptionDuration');
            
            if (goToPaymentBtn && purchaseSubscriptionType && purchaseSubscriptionDuration) {
                // Пользователь авторизован - показываем кнопку оплаты
                purchaseSubscriptionType.value = type;
                purchaseSubscriptionDuration.value = duration;
                goToPaymentBtn.style.display = 'block';
                goToPaymentBtn.innerHTML = `<i class="bi bi-credit-card"></i> Перейти к оплате (${typeText} ${durationText})`;
                // Прокручиваем к кнопке
                goToPaymentBtn.scrollIntoView({ behavior: 'smooth', block: 'center' });
            } else {
                // Пользователь не авторизован - показываем модальное окно
                modal.show();
            }
        });
    });
});
</script>

<%- include('partials/footer') %>

